<!DOCTYPE HTML>
<html>
    
	<head>
		<title>Personal blog around mobile monetization, android and ios development</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="description" content="Personal blog around mobile monetization, Android and iOS development and other things learned while developing mobile apps for both platforms." />
		<meta name="keywords" content="android,monetization" />
		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
		<script src="/js/jquery.min.js"></script>
		<script src="/js/jquery.scrollzer.min.js"></script>
		<script src="/js/jquery.scrolly.min.js"></script>
		<script src="/js/skel.min.js"></script>
		<script src="/js/skel-layers.min.js"></script>
		<script src="/js/init.js"></script>
		<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73073179-1', 'auto');
  ga('send', 'pageview');

</script>
		<noscript>
			<link rel="stylesheet" href="/css/skel.css" />
			<link rel="stylesheet" href="/css/style.css" />
			<link rel="stylesheet" href="/css/style-xlarge.css" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" >

		</noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
	</head>
		
    <body>
        <div id="wrapper">
        <!-- Header -->
    <section id="header" class="skel-layers-fixed">
        <header>
            <span class="image avatar"><img src="/images/avatar.png" alt="" /></span>
            <h1 id="logo"><a href="/">Andreas Vourkos</a></h1>
              <p>Building mobile apps since the early days of J2ME...</p>
            <span class="image pollfish"><a href="https://www.pollfish.com" target="_blank"> <img  src="/images/polfish.png" alt="" /></a></span>
          <p>The mobile engineer behind <a href="https://www.pollfish.com" target="_blank">Pollfish</a> Android and iOS SDKs</p>

        </header>
        <nav id="nav">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/android">Android Development</a></li>
                         <li><a href="/ios">iOS Development</a></li>
                <li><a href="/monetization">Monetization Tips</a></li>
            </ul>
        </nav>
        <footer>
            <ul class="icons">
                 <li><a href="https://twitter.com/vourkosa" class="icon fa-twitter" target="_blank"><span class="label">Twitter</span></a></li>
                <li><a href="https://www.linkedin.com/in/andreasvourkos" class="icon fa-linkedin" target="_blank"><span class="label">Linkedin</span></a></li>
                <li><a href="https://github.com/vourkosa" class="icon fa-github" target="_blank"><span class="label">Github</span></a></li>
            </ul>
        </footer>
    </section>



            <!-- Main -->
            <div id="main">
                <section>
 
    <div class="container">
    
        <header class="major">
            <h2>Working with overlays - Life under WindowManager</h2>
                <p class="post-meta">15 January 2016&nbsp;&nbsp; | &nbsp;&nbsp; Android    </p>  
        </header>

        <section class="post-content">
            <p>This is the start of a series of articles regarding creating and using overlays on Android.  An overlay is a view that is placed above other views.  Such views can be created on Android with several different ways and for different purposes.</p>

<p>There are several usages for overlays on Android. Some of them include:</p>

<ol>
<li>Floating buttons/menus</li>
<li>Onboarding tutorials</li>
<li>Advertising</li>
<li>Augmented Reality</li>
<li>Fancy animations</li>
</ol>

<h3>Life under WindowManager</h3>

<p>In this article we will see how we can create an overlay view that will lie on top of other applications with the help of WindowManager.</p>

<p>But let’s see first what is a <a href="http://developer.android.com/reference/android/view/WindowManager.html" target="_blank">WindowManager.</a> WindowManager is a system service responsible for organizing the screen. It interacts with applications to create windows and decides where they will go on the screen and in which order. When creating a window, WindowManager requests a Surface for that window and on that Surface, an application will draw its user interface. Each window is a container of views and has its own view hierarchy.</p>

<p><u>But let's be more specific and list what a WindowManager is and what it does:</u></p>
<ul>
<li>A system service </li>
<li>It requests the creation and allocation of surfaces for the clients (applications)</li>
<li>Is responsible of which windows are visible, their z-order and how they are laid on the screen </li>
<li>It deals and dispatches input and focus events to clients </li>
<li>It <a href="https://source.android.com/devices/graphics/" target="_blank">oversees</a> transitions, screen orientation and animations </li>
<li>It sends all of the window metadata to SurfaceFlinger so SurfaceFlinger can use that data to composite surfaces on the display.</li>
<li>Each instance of WindowManager is bound to a particular Display </li>
<li>WindowManager never deals with the bits of the created surfaces, it is up to the clients to do so, and they do it directly without going through the WindowManager </li>
</ul>

<p>During the windows creation process and the management of their lifecycle we will meet the term of Window Token a special type of Binder object. A Binder is an Android-specific interprocess communication mechanism and also remote method invocation system. In Android framework Window Tokens, and Binder objects in general, are used extensively for security reasons. A Window Token uniquely identifies a window, and is used by WindowManager to decide whether or not a window is allowed to be placed at a requested position. Applications can obtain their own window tokens, but they do not have access to the tokens of other applications. This way, the framework can constrain an app to its own sandbox and does not allow applications to draw windows above other applications.</p>

<p>For example, during an application launch through ActivityMangerService, a Window Token (that is called Application Window Token) is created and is passed both to the application and the WindowManager. This token identifies uniquely the top window view of the application. When the application wants to add or remove windows it passes this token to WindowManager which decides if they can be created at the requested place and where they should go. This way when the ActivityManager wants to close or hide all windows created by the activity, it can easily request this by providing the relevant token to the WindowManager.</p>

<p><u>In general we can say that we have two types of Window Tokens:</u></p>
<ul>
<li><b>AppWindowToken</b> which is the handle for an Activity that it uses to display windows. It’s a specific version of WindowToken relevant to  a particular application or activity that is displaying windows</li>
<li><b>WindowToken</b> which is the container of a set of related windows in the WindowManager.  For nested windows, there is a WindowToken created for  the parent window to manage its children. </li>
</ul>

<p>You can read more about window tokens and how they are handled, in the following articles: <a href="http://www.androiddesignpatterns.com/2013/07/binders-window-tokens.html" target="_blank">“Binders &amp; Window Tokens” </a> and <a href="http://blog.csdn.net/luoshengyang/article/details/8275938" target="_blank">“Android application window (Activity) view objects (View) creation process analysis” </a>.</p>

<p><u>There are 3 main classes of windows:</u></p>
<ul>
<li><b>Application windows</b> are normal top level windows. For these types of windows, their token must be set to the token of the activity they are a part of. </li>
<li><b>Sub-windows</b> are windows that are associated with another top-level window. These kind of windows have the token of the window they are attached to. </li>
<li><b>System windows</b> are special types of windows for use by the system for specific purposes like status bar, search bar, toast notifications and others. They are not normally used by applications and a special permission is required to use them. This kind of windows can overlay above other applications. For creating and using system windows, prior the release of Android Marshmallow it was only necessary to include in Android Manifest the permission SYSTEM\_ALERT\_WINDOW </li>
</ul>
<div class="highlighter-rouge"><pre class="highlight"><code>&lt;uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/&gt;
</code></pre>
</div>

<p>However since Android Marshmallow a special request is required with a direct action by the user in order to allow an app to create and add or remove windows above other apps (System windows). This permission is not included in the new request permission structure that was introduced in Marshmallow and follows a completely different approach. One of its major differences is that it cannot be granted through the app like all the other permissions.</p>

<p>Since Android 6.0 developers can call <b><a href="http://developer.android.com/reference/android/provider/Settings.html#canDrawOverlays(android.content.Context)" target="_blank">Settings.canDrawOverlays() </a></b> to check if the specific context was granted permission in order to draw on top of other apps. If permission hasn’t been granted yet, user can create and fire an Intent with destination set to <b>Settings.ACTION_MANAGE_OVERLAY_PERMISSION</b> accompanied with URI of the package name of the app to send users directly to give permission to your app yo draw above others.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">OVERLAY_PERMISSION_CODE</span> <span class="o">=</span> <span class="mi">2525</span><span class="o">;</span>  

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addOverlay</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>     
	<span class="k">if</span> <span class="o">(!</span><span class="n">Settings</span><span class="o">.</span><span class="na">canDrawOverlays</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">{</span>         
			<span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Settings</span><span class="o">.</span><span class="na">ACTION_MANAGE_OVERLAY_PERMISSION</span><span class="o">,</span><span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"package:"</span> <span class="o">+</span> <span class="n">getPackageName</span><span class="o">()));</span>
        	<span class="n">startActivityForResult</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">OVERLAY_PERMISSION_REQ_CODE</span><span class="o">);</span>     
	<span class="o">}</span> 
<span class="o">}</span>
</code></pre>
</div>

<p>and then when the user returns to the app a check is made if permission was granted:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
<span class="nd">@Override</span> 
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="p">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>    
 
 <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="n">OVERLAY_PERMISSION_CODE</span><span class="o">)</span> <span class="o">{</span>         
 		<span class="k">if</span> <span class="o">(!</span><span class="n">Settings</span><span class="o">.</span><span class="na">canDrawOverlays</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">{</span>             
 		<span class="c1">// SYSTEM_ALERT_WINDOW permission not granted...         </span>
 		<span class="o">}</span>     
 	<span class="o">}</span> 
 <span class="o">}</span>
</code></pre>
</div>

<p>Now that we have listed some important information on how are windows handled through WindowMananger and the window types available, let’s see how we can create an overlay that will exist above other apps through WindowMananger.</p>

<p>In general when an app is in the foreground, users can interact with it and they loose this ability when it goes to the background and is paused. With WindowManager you can easily add an overlay view in a System Window on top of everything, that users can still interact with, even if the application is paused and is hidden.</p>

<p>Depending on how you want this overlay view to be placed and the lifetime that you want to achieve, you can obtain reference to WindowManager with different ways and add a view through an Activity or a Service.</p>

<h4>1. Overlay through the context of an activity</h4>

<p>A WindowManager can be easily obtained:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">WindowManager</span> <span class="n">wm</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">WINDOW_SERVICE</span><span class="o">);</span>
</code></pre>
</div>

<p>You need then to define WindowManager layout params.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">();</span>

<span class="n">Point</span> <span class="n">point</span> <span class="o">=</span> <span class="n">OverlayUtil</span><span class="o">.</span><span class="na">getScreenDimensions</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

<span class="n">params</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">y</span><span class="o">*</span> <span class="mi">7</span><span class="o">/</span><span class="mi">10</span><span class="o">;</span>
<span class="n">params</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">;.</span>

<span class="n">params</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_PRIORITY_PHONE</span><span class="o">;</span>
<span class="n">params</span><span class="o">.</span><span class="na">flags</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_FOCUSABLE</span> <span class="o">|</span>
         <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_LAYOUT_NO_LIMITS</span> <span class="o">|</span>
         <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_TOUCH_MODAL</span><span class="o">;</span>
<span class="n">params</span><span class="o">.</span><span class="na">format</span> <span class="o">=</span> <span class="n">PixelFormat</span><span class="o">.</span><span class="na">TRANSLUCENT</span><span class="o">;</span>
<span class="n">params</span><span class="o">.</span><span class="na">gravity</span> <span class="o">=</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">CENTER</span> <span class="o">|</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">LEFT</span><span class="o">;</span>

<span class="n">wm</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">overlayView</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
</code></pre>
</div>

<p>and then we try to add our Overlay view  method</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">addView</span><span class="o">(</span><span class="n">View</span><span class="o">,</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">)</span>
</code></pre>
</div>

<p><u>This methods performs three major steps:</u></p>

<ul>
<li>Checks whether the window has been already been added</li>
<li>Determines the type of the window and if is a child window, and if yes, it attaches it to its parent window</li> 
<li>It creates a new ViewRootImpl object and calls its setView method.</li>
</ul>

<p>As you may see, we specified as window type TYPE_PRIORITY_PHONE which is one of System Window types. This type is a non-application window type that is normally placed above all applications but resides behind the status bar. Another type that could be used would be TYPE_SYSTEM_ALERT that is a system window like low power alert and is also placed above other applications.</p>

<p>If we try to add this window without being granted the permission SYSTEM_ALERT_WINDOW that enables adding or removing system windows, a BadToken Exception will occur since WindowManager understands that the application is trying to add a Security Window that can render above other apps without having the right token.</p>

<p><img src="/images/android/badtoken.png" /></p>

<p>Once you add an overlay view as a System Window with window manager through the context of an activity, a new window with its own view hierarchy is created and added above the current window of the activity.</p>

<p><img src="/images/android/overlay_processes.png" /></p>

<p>We can use Android Device Monitor and Hierarchy Viewer to see the list of available windows on the system.</p>

<p><img src="/images/android/windows_list1.png" /></p>

<p>As we can see a new window is created with its own view hierarchy. This window has a null window token however is associated as we may see with the MainActivity.</p>

<p><img src="/images/android/windows_list2.png" /></p>

<p>This is the same list we can get from</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">adb</span> <span class="n">shell</span> <span class="n">dumpsys</span> <span class="n">window</span> <span class="n">windows</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">WINDOW</span> <span class="n">MANAGER</span> <span class="nf">WINDOWS</span> <span class="p">(</span><span class="n">dumpsys</span> <span class="n">window</span> <span class="n">windows</span><span class="o">)</span>

<span class="o">.....</span>

  <span class="n">Window</span> <span class="err">#</span><span class="mi">3</span> <span class="n">Window</span><span class="o">{</span><span class="mi">1</span><span class="n">fb8d3e0</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}:</span>
    <span class="n">mDisplayId</span><span class="o">=</span><span class="mi">0</span> <span class="n">mSession</span><span class="o">=</span><span class="n">Session</span><span class="o">{</span><span class="mi">27</span><span class="n">d0ccae</span> <span class="mi">6335</span><span class="o">:</span><span class="n">u0a10090</span><span class="o">}</span> <span class="n">mClient</span><span class="o">=</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">BinderProxy</span><span class="err">@</span><span class="mi">7</span><span class="n">c1dde3</span>
    <span class="n">mOwnerUid</span><span class="o">=</span><span class="mi">10090</span> <span class="n">mShowToOwnerOnly</span><span class="o">=</span><span class="kc">true</span> <span class="kn">package</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span> <span class="n">appop</span><span class="o">=</span><span class="n">SYSTEM_ALERT_WINDOW</span>
    <span class="n">mAttrs</span><span class="o">=</span><span class="n">WM</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">{(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">)(</span><span class="n">fillx1243</span><span class="o">)</span> <span class="n">gr</span><span class="o">=</span><span class="err">#</span><span class="mi">13</span> <span class="n">sim</span><span class="o">=</span><span class="err">#</span><span class="mi">20</span> <span class="n">ty</span><span class="o">=</span><span class="mi">2007</span> <span class="n">fl</span><span class="o">=</span><span class="err">#</span><span class="mi">1000228</span> <span class="n">fmt</span><span class="o">=-</span><span class="mi">3</span> <span class="n">surfaceInsets</span><span class="o">=</span><span class="n">Rect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)}</span>
    <span class="n">Requested</span> <span class="n">w</span><span class="o">=</span><span class="mi">1080</span> <span class="n">h</span><span class="o">=</span><span class="mi">1243</span> <span class="n">mLayoutSeq</span><span class="o">=</span><span class="mi">139</span>
    <span class="n">mBaseLayer</span><span class="o">=</span><span class="mi">81000</span> <span class="n">mSubLayer</span><span class="o">=</span><span class="mi">0</span> <span class="n">mAnimLayer</span><span class="o">=</span><span class="mi">81000</span><span class="o">+</span><span class="mi">0</span><span class="o">=</span><span class="mi">81000</span> <span class="n">mLastLayer</span><span class="o">=</span><span class="mi">81000</span>
    <span class="n">mToken</span><span class="o">=</span><span class="n">WindowToken</span><span class="o">{</span><span class="mi">1180</span><span class="n">a699</span> <span class="kc">null</span><span class="o">}</span>
    <span class="n">mRootToken</span><span class="o">=</span><span class="n">WindowToken</span><span class="o">{</span><span class="mi">1</span><span class="n">a074e0c</span> <span class="kc">null</span><span class="o">}</span>
    <span class="n">mViewVisibility</span><span class="o">=</span><span class="mh">0x0</span> <span class="n">mHaveFrame</span><span class="o">=</span><span class="kc">true</span> <span class="n">mObscured</span><span class="o">=</span><span class="kc">false</span>
    <span class="n">mSeq</span><span class="o">=</span><span class="mi">0</span> <span class="n">mSystemUiVisibility</span><span class="o">=</span><span class="mh">0x0</span>
    <span class="n">mGivenContentInsets</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">mGivenVisibleInsets</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span>
    <span class="n">mConfiguration</span><span class="o">={</span><span class="mf">1.0</span> <span class="mi">310</span><span class="n">mcc260mnc</span> <span class="n">en_US</span> <span class="o">?</span><span class="n">layoutDir</span> <span class="n">sw360dp</span> <span class="n">w360dp</span> <span class="n">h567dp</span> <span class="mi">480</span><span class="n">dpi</span> <span class="n">nrml</span> <span class="n">port</span> <span class="n">finger</span> <span class="n">qwerty</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">v</span> <span class="n">dpad</span><span class="o">/</span><span class="n">v</span> <span class="n">s</span><span class="o">.</span><span class="mi">6</span><span class="o">}</span>
    <span class="n">mHasSurface</span><span class="o">=</span><span class="kc">true</span> <span class="n">mShownFrame</span><span class="o">=[</span><span class="mf">0.0</span><span class="o">,</span><span class="mf">304.0</span><span class="o">][</span><span class="mf">1080.0</span><span class="o">,</span><span class="mf">1547.0</span><span class="o">]</span> <span class="n">isReadyForDisplay</span><span class="o">()=</span><span class="kc">true</span>
    <span class="n">mFrame</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">304</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1547</span><span class="o">]</span> <span class="n">last</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">304</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1547</span><span class="o">]</span>
    <span class="n">mSystemDecorRect</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1243</span><span class="o">]</span> <span class="n">last</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span>
    <span class="nl">Frames:</span> <span class="n">containing</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1776</span><span class="o">]</span> <span class="n">parent</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1776</span><span class="o">]</span>
        <span class="n">display</span><span class="o">=[-</span><span class="mi">10000</span><span class="o">,-</span><span class="mi">10000</span><span class="o">][</span><span class="mi">10000</span><span class="o">,</span><span class="mi">10000</span><span class="o">]</span> <span class="n">overscan</span><span class="o">=[-</span><span class="mi">10000</span><span class="o">,-</span><span class="mi">10000</span><span class="o">][</span><span class="mi">10000</span><span class="o">,</span><span class="mi">10000</span><span class="o">]</span>
        <span class="n">content</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">304</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1547</span><span class="o">]</span> <span class="n">visible</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">304</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1547</span><span class="o">]</span>
        <span class="n">decor</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span>
    <span class="n">Cur</span> <span class="nl">insets:</span> <span class="n">overscan</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">content</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">visible</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">stable</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span>
    <span class="n">Lst</span> <span class="nl">insets:</span> <span class="n">overscan</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">content</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">visible</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">stable</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span>
    <span class="n">WindowStateAnimator</span><span class="o">{</span><span class="mi">5101</span><span class="n">a36</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}:</span>
      <span class="n">mSurface</span><span class="o">=</span><span class="n">Surface</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">)</span>
      <span class="n">mDrawState</span><span class="o">=</span><span class="n">HAS_DRAWN</span> <span class="n">mLastHidden</span><span class="o">=</span><span class="kc">false</span>
      <span class="nl">Surface:</span> <span class="n">shown</span><span class="o">=</span><span class="kc">true</span> <span class="n">layer</span><span class="o">=</span><span class="mi">81000</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="n">rect</span><span class="o">=(</span><span class="mf">0.0</span><span class="o">,</span><span class="mf">304.0</span><span class="o">)</span> <span class="mf">1080.0</span> <span class="n">x</span> <span class="mf">1243.0</span>
  <span class="n">Window</span> <span class="err">#</span><span class="mi">2</span> <span class="n">Window</span><span class="o">{</span><span class="mi">14</span><span class="n">eaa6e5</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}:</span>
    <span class="n">mDisplayId</span><span class="o">=</span><span class="mi">0</span> <span class="n">mSession</span><span class="o">=</span><span class="n">Session</span><span class="o">{</span><span class="mi">27</span><span class="n">d0ccae</span> <span class="mi">6335</span><span class="o">:</span><span class="n">u0a10090</span><span class="o">}</span> <span class="n">mClient</span><span class="o">=</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">BinderProxy</span><span class="err">@</span><span class="mi">25</span><span class="n">bcb5dc</span>
    <span class="n">mOwnerUid</span><span class="o">=</span><span class="mi">10090</span> <span class="n">mShowToOwnerOnly</span><span class="o">=</span><span class="kc">true</span> <span class="kn">package</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span> <span class="n">appop</span><span class="o">=</span><span class="n">NONE</span>
    <span class="n">mAttrs</span><span class="o">=</span><span class="n">WM</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">{(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">)(</span><span class="n">fillxfill</span><span class="o">)</span> <span class="n">sim</span><span class="o">=</span><span class="err">#</span><span class="mi">120</span> <span class="n">ty</span><span class="o">=</span><span class="mi">1</span> <span class="n">fl</span><span class="o">=</span><span class="err">#</span><span class="mi">81810100</span> <span class="n">wanim</span><span class="o">=</span><span class="mh">0x1030466</span> <span class="n">vsysui</span><span class="o">=</span><span class="mh">0x600</span> <span class="n">surfaceInsets</span><span class="o">=</span><span class="n">Rect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="n">needsMenuKey</span><span class="o">=</span><span class="mi">2</span><span class="o">}</span>
    <span class="n">Requested</span> <span class="n">w</span><span class="o">=</span><span class="mi">1080</span> <span class="n">h</span><span class="o">=</span><span class="mi">1776</span> <span class="n">mLayoutSeq</span><span class="o">=</span><span class="mi">139</span>
    <span class="n">mBaseLayer</span><span class="o">=</span><span class="mi">21000</span> <span class="n">mSubLayer</span><span class="o">=</span><span class="mi">0</span> <span class="n">mAnimLayer</span><span class="o">=</span><span class="mi">21010</span><span class="o">+</span><span class="mi">0</span><span class="o">=</span><span class="mi">21010</span> <span class="n">mLastLayer</span><span class="o">=</span><span class="mi">21010</span>
    <span class="n">mToken</span><span class="o">=</span><span class="n">AppWindowToken</span><span class="o">{</span><span class="mi">2</span><span class="n">a8c4f1</span> <span class="n">token</span><span class="o">=</span><span class="n">Token</span><span class="o">{</span><span class="mi">15</span><span class="n">ff9498</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">398</span><span class="n">cce7b</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/.</span><span class="na">MainActivity</span> <span class="n">t612</span><span class="o">}}}</span>
    <span class="n">mRootToken</span><span class="o">=</span><span class="n">AppWindowToken</span><span class="o">{</span><span class="mi">2</span><span class="n">a8c4f1</span> <span class="n">token</span><span class="o">=</span><span class="n">Token</span><span class="o">{</span><span class="mi">15</span><span class="n">ff9498</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">398</span><span class="n">cce7b</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/.</span><span class="na">MainActivity</span> <span class="n">t612</span><span class="o">}}}</span>
    <span class="n">mAppToken</span><span class="o">=</span><span class="n">AppWindowToken</span><span class="o">{</span><span class="mi">2</span><span class="n">a8c4f1</span> <span class="n">token</span><span class="o">=</span><span class="n">Token</span><span class="o">{</span><span class="mi">15</span><span class="n">ff9498</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">398</span><span class="n">cce7b</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/.</span><span class="na">MainActivity</span> <span class="n">t612</span><span class="o">}}}</span>
    <span class="n">mViewVisibility</span><span class="o">=</span><span class="mh">0x0</span> <span class="n">mHaveFrame</span><span class="o">=</span><span class="kc">true</span> <span class="n">mObscured</span><span class="o">=</span><span class="kc">false</span>
    <span class="n">mSeq</span><span class="o">=</span><span class="mi">0</span> <span class="n">mSystemUiVisibility</span><span class="o">=</span><span class="mh">0x600</span>
    <span class="n">mGivenContentInsets</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">mGivenVisibleInsets</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span>
    <span class="n">mConfiguration</span><span class="o">={</span><span class="mf">1.0</span> <span class="mi">310</span><span class="n">mcc260mnc</span> <span class="n">en_US</span> <span class="o">?</span><span class="n">layoutDir</span> <span class="n">sw360dp</span> <span class="n">w360dp</span> <span class="n">h567dp</span> <span class="mi">480</span><span class="n">dpi</span> <span class="n">nrml</span> <span class="n">port</span> <span class="n">finger</span> <span class="n">qwerty</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">v</span> <span class="n">dpad</span><span class="o">/</span><span class="n">v</span> <span class="n">s</span><span class="o">.</span><span class="mi">6</span><span class="o">}</span>
    <span class="n">mHasSurface</span><span class="o">=</span><span class="kc">true</span> <span class="n">mShownFrame</span><span class="o">=[</span><span class="mf">0.0</span><span class="o">,</span><span class="mf">0.0</span><span class="o">][</span><span class="mf">1080.0</span><span class="o">,</span><span class="mf">1920.0</span><span class="o">]</span> <span class="n">isReadyForDisplay</span><span class="o">()=</span><span class="kc">true</span>
    <span class="n">mFrame</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span> <span class="n">last</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span>
    <span class="n">mSystemDecorRect</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span> <span class="n">last</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span>
    <span class="nl">Frames:</span> <span class="n">containing</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span> <span class="n">parent</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span>
        <span class="n">display</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span> <span class="n">overscan</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span>
        <span class="n">content</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1776</span><span class="o">]</span> <span class="n">visible</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1776</span><span class="o">]</span>
        <span class="n">decor</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">1080</span><span class="o">,</span><span class="mi">1920</span><span class="o">]</span>
    <span class="n">Cur</span> <span class="nl">insets:</span> <span class="n">overscan</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">content</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">144</span><span class="o">]</span> <span class="n">visible</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">144</span><span class="o">]</span> <span class="n">stable</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">144</span><span class="o">]</span>
    <span class="n">Lst</span> <span class="nl">insets:</span> <span class="n">overscan</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">]</span> <span class="n">content</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">144</span><span class="o">]</span> <span class="n">visible</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">144</span><span class="o">]</span> <span class="n">stable</span><span class="o">=[</span><span class="mi">0</span><span class="o">,</span><span class="mi">75</span><span class="o">][</span><span class="mi">0</span><span class="o">,</span><span class="mi">144</span><span class="o">]</span>
    <span class="n">WindowStateAnimator</span><span class="o">{</span><span class="n">b9bcd37</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}:</span>
      <span class="n">mSurface</span><span class="o">=</span><span class="n">Surface</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">)</span>
      <span class="n">mDrawState</span><span class="o">=</span><span class="n">HAS_DRAWN</span> <span class="n">mLastHidden</span><span class="o">=</span><span class="kc">false</span>
      <span class="nl">Surface:</span> <span class="n">shown</span><span class="o">=</span><span class="kc">true</span> <span class="n">layer</span><span class="o">=</span><span class="mi">21010</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="n">rect</span><span class="o">=(</span><span class="mf">0.0</span><span class="o">,</span><span class="mf">0.0</span><span class="o">)</span> <span class="mf">1080.0</span> <span class="n">x</span> <span class="mf">1920.0</span>

 <span class="o">....</span>
</code></pre>
</div>
<p>and we can also get a lost of window tokens with</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">adb</span> <span class="n">shell</span> <span class="n">dumpsys</span> <span class="n">window</span> <span class="n">tokens</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">WINDOW</span> <span class="n">MANAGER</span> <span class="nf">TOKENS</span> <span class="p">(</span><span class="n">dumpsys</span> <span class="n">window</span> <span class="n">tokens</span><span class="o">)</span>
  <span class="n">All</span> <span class="nl">tokens:</span>
  <span class="n">WindowToken</span><span class="o">{</span><span class="mi">1180</span><span class="n">a699</span> <span class="kc">null</span><span class="o">}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">1</span><span class="n">fb8d3e0</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=-</span><span class="mi">1</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>
  <span class="n">AppWindowToken</span><span class="o">{</span><span class="mi">2</span><span class="n">a8c4f1</span> <span class="n">token</span><span class="o">=</span><span class="n">Token</span><span class="o">{</span><span class="mi">15</span><span class="n">ff9498</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">398</span><span class="n">cce7b</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/.</span><span class="na">MainActivity</span> <span class="n">t612</span><span class="o">}}}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">14</span><span class="n">eaa6e5</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=</span><span class="mi">2</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">app</span><span class="o">=</span><span class="kc">true</span> <span class="n">voiceInteraction</span><span class="o">=</span><span class="kc">false</span>
    <span class="n">allAppWindows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">14</span><span class="n">eaa6e5</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">groupId</span><span class="o">=</span><span class="mi">612</span> <span class="n">appFullscreen</span><span class="o">=</span><span class="kc">true</span> <span class="n">requestedOrientation</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">hiddenRequested</span><span class="o">=</span><span class="kc">false</span> <span class="n">clientHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">willBeHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">reportedDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">reportedVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">numInterestingWindows</span><span class="o">=</span><span class="mi">1</span> <span class="n">numDrawnWindows</span><span class="o">=</span><span class="mi">1</span> <span class="n">inPendingTransaction</span><span class="o">=</span><span class="kc">false</span> <span class="n">allDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="o">(</span><span class="n">animator</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="n">startingData</span><span class="o">=</span><span class="kc">null</span> <span class="n">removed</span><span class="o">=</span><span class="kc">false</span> <span class="n">firstWindowDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">mDeferRemoval</span><span class="o">=</span><span class="kc">false</span>
    
<span class="o">...</span>
</code></pre>
</div>

<p>We can see from the list of available tokens that we have the top level AppWindowToken for MainActivity and WindowToken for our overlay window is also listed but has a null value.</p>

<p>If we start a second activity, without destroying the first activity, we can see that a new window and a new AppWindowToken has been created for that activity while the overlay view still resides on top of everything.</p>

<p><img src="/images/android/second_activity.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">WINDOW</span> <span class="n">MANAGER</span> <span class="nf">TOKENS</span> <span class="p">(</span><span class="n">dumpsys</span> <span class="n">window</span> <span class="n">tokens</span><span class="o">)</span>
  <span class="n">All</span> <span class="nl">tokens:</span>
  <span class="n">WindowToken</span><span class="o">{</span><span class="mi">38</span><span class="n">eaa3b8</span> <span class="kc">null</span><span class="o">}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">37</span><span class="n">fadf5d</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=-</span><span class="mi">1</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>
  <span class="n">AppWindowToken</span><span class="o">{</span><span class="mi">572</span><span class="n">ee3b</span> <span class="n">token</span><span class="o">=</span><span class="n">Token</span><span class="o">{</span><span class="mi">2622</span><span class="n">ccca</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">429</span><span class="n">e035</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/.</span><span class="na">MainActivity</span> <span class="n">t613</span><span class="o">}}}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="n">f186e0f</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=</span><span class="mi">2</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">true</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">app</span><span class="o">=</span><span class="kc">true</span> <span class="n">voiceInteraction</span><span class="o">=</span><span class="kc">false</span>
    <span class="n">allAppWindows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="n">f186e0f</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">groupId</span><span class="o">=</span><span class="mi">613</span> <span class="n">appFullscreen</span><span class="o">=</span><span class="kc">true</span> <span class="n">requestedOrientation</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">hiddenRequested</span><span class="o">=</span><span class="kc">true</span> <span class="n">clientHidden</span><span class="o">=</span><span class="kc">true</span> <span class="n">willBeHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">reportedDrawn</span><span class="o">=</span><span class="kc">false</span> <span class="n">reportedVisible</span><span class="o">=</span><span class="kc">false</span>
    <span class="n">numInterestingWindows</span><span class="o">=</span><span class="mi">2</span> <span class="n">numDrawnWindows</span><span class="o">=</span><span class="mi">2</span> <span class="n">inPendingTransaction</span><span class="o">=</span><span class="kc">false</span> <span class="n">allDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="o">(</span><span class="n">animator</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="n">startingData</span><span class="o">=</span><span class="kc">null</span> <span class="n">removed</span><span class="o">=</span><span class="kc">false</span> <span class="n">firstWindowDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">mDeferRemoval</span><span class="o">=</span><span class="kc">false</span>
<span class="o">....</span>
<span class="n">AppWindowToken</span><span class="o">{</span><span class="mi">7</span><span class="n">d560a0</span> <span class="n">token</span><span class="o">=</span><span class="n">Token</span><span class="o">{</span><span class="mi">6</span><span class="n">f9a5a3</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">24</span><span class="n">cda0d2</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/.</span><span class="na">SecondActivity</span> <span class="n">t613</span><span class="o">}}}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="n">bc0f81e</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">SecondActivity</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=</span><span class="mi">2</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">app</span><span class="o">=</span><span class="kc">true</span> <span class="n">voiceInteraction</span><span class="o">=</span><span class="kc">false</span>
    <span class="n">allAppWindows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="n">bc0f81e</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">SecondActivity</span><span class="o">}]</span>
    <span class="n">groupId</span><span class="o">=</span><span class="mi">613</span> <span class="n">appFullscreen</span><span class="o">=</span><span class="kc">true</span> <span class="n">requestedOrientation</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">hiddenRequested</span><span class="o">=</span><span class="kc">false</span> <span class="n">clientHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">willBeHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">reportedDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">reportedVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">numInterestingWindows</span><span class="o">=</span><span class="mi">1</span> <span class="n">numDrawnWindows</span><span class="o">=</span><span class="mi">1</span> <span class="n">inPendingTransaction</span><span class="o">=</span><span class="kc">false</span> <span class="n">allDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="o">(</span><span class="n">animator</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="n">startingData</span><span class="o">=</span><span class="kc">null</span> <span class="n">removed</span><span class="o">=</span><span class="kc">false</span> <span class="n">firstWindowDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">mDeferRemoval</span><span class="o">=</span><span class="kc">false</span>
<span class="o">....</span>

</code></pre>
</div>

<p>As far as the activity is not destroyed there is no issue. However, once that activity is destroyed a Window leak occurs if the overlay view is not removed in advance.</p>

<p>If we dive deeper into this, we will see that what happens is relevant to Window Tokens. If we see into Android code, in <a heref="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/view/WindowManagerGlobal.java"> WindowManagerGlobal </a> implementation, when an activity is destroyed, it notifies WindowManagerGlobal to try and close all windows associated with that activity. The overlay window has a null window token but is still referenced from the context of the activity.<br />
This is the point where a window leak will occur.</p>

<p>WindowManagerGlobal.java</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">closeAll</span><span class="p">(</span><span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="n">String</span> <span class="n">who</span><span class="o">,</span> <span class="n">String</span> <span class="n">what</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mViews</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span><span class="o">;</span>
            
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mViews</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="c1">//Log.i("foo", "Closing all windows of " + token);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="c1">//Log.i("foo", "@ " + i + " token " + mParams[i].token</span>
                <span class="c1">//        + " view " + mRoots[i].getView());</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">mParams</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">token</span> <span class="o">==</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ViewRootImpl</span> <span class="n">root</span> <span class="o">=</span> <span class="n">mRoots</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                    <span class="n">root</span><span class="o">.</span><span class="na">mAddNesting</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    
                    <span class="c1">//Log.i("foo", "Force closing " + root);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">who</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">WindowLeaked</span> <span class="n">leak</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowLeaked</span><span class="o">(</span>
                                <span class="n">what</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">who</span> <span class="o">+</span> <span class="s">" has leaked window "</span>
                                <span class="o">+</span> <span class="n">root</span><span class="o">.</span><span class="na">getView</span><span class="o">()</span> <span class="o">+</span> <span class="s">" that was originally added here"</span><span class="o">);</span>
                        <span class="n">leak</span><span class="o">.</span><span class="na">setStackTrace</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">getLocation</span><span class="o">().</span><span class="na">getStackTrace</span><span class="o">());</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"WindowManager"</span><span class="o">,</span> <span class="n">leak</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">leak</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="n">removeViewLocked</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="n">i</span><span class="o">--;</span>
                    <span class="n">count</span><span class="o">--;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>So what can we do as a workaround to avoid a window leak and keep our overlay window above the system even if the activity that created is destroyed?</p>

<p><u>There are two different ways to achieve that:</u></p>

<p><img src="/images/android/landing.png" /></p>

<p>a) By assigning a token to the new Security Window before calling WindowManager to add it in its WindowManager LayoutParams</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">params</span><span class="o">.</span><span class="na">token</span><span class="o">=</span><span class="k">new</span> <span class="n">Binder</span><span class="o">();</span>
</code></pre>
</div>
<p>From the list of tokens we can see that the Overlay window has now a token</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">WINDOW</span> <span class="n">MANAGER</span> <span class="nf">TOKENS</span> <span class="p">(</span><span class="n">dumpsys</span> <span class="n">window</span> <span class="n">tokens</span><span class="o">)</span>
  <span class="n">All</span> <span class="nl">tokens:</span>
  <span class="n">WindowToken</span><span class="o">{</span><span class="mi">2</span><span class="n">bdf2e70</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">BinderProxy</span><span class="err">@</span><span class="mi">39</span><span class="n">a72622</span><span class="o">}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">1</span><span class="n">a15c8b3</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=-</span><span class="mi">1</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>

<span class="o">...</span>

  <span class="n">AppWindowToken</span><span class="o">{</span><span class="mi">2</span><span class="n">d2fc41a</span> <span class="n">token</span><span class="o">=</span><span class="n">Token</span><span class="o">{</span><span class="n">c1de2c5</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">39</span><span class="n">c9f53c</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/.</span><span class="na">MainActivity</span> <span class="n">t616</span><span class="o">}}}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">219167</span><span class="n">ca</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=</span><span class="mi">2</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">app</span><span class="o">=</span><span class="kc">true</span> <span class="n">voiceInteraction</span><span class="o">=</span><span class="kc">false</span>
    <span class="n">allAppWindows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">219167</span><span class="n">ca</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">groupId</span><span class="o">=</span><span class="mi">616</span> <span class="n">appFullscreen</span><span class="o">=</span><span class="kc">true</span> <span class="n">requestedOrientation</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">hiddenRequested</span><span class="o">=</span><span class="kc">false</span> <span class="n">clientHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">willBeHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">reportedDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">reportedVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">numInterestingWindows</span><span class="o">=</span><span class="mi">1</span> <span class="n">numDrawnWindows</span><span class="o">=</span><span class="mi">1</span> <span class="n">inPendingTransaction</span><span class="o">=</span><span class="kc">false</span> <span class="n">allDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="o">(</span><span class="n">animator</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="n">startingData</span><span class="o">=</span><span class="kc">null</span> <span class="n">removed</span><span class="o">=</span><span class="kc">false</span> <span class="n">firstWindowDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">mDeferRemoval</span><span class="o">=</span><span class="kc">false</span>
    
<span class="o">...</span>    
</code></pre>
</div>

<p>This way we make the Overlay view stay alive and be independent of the activity’s lifecycle. However once the app is destroyed, the Overlay window will be removed too.</p>

<p>b) By getting reference to the WindowManager through application’s Context</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">WindowManager</span> <span class="n">wm</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span> <span class="n">getApplicationContext</span><span class="o">().</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">WINDOW_SERVICE</span><span class="o">);</span>
</code></pre>
</div>

<p>If we obtain reference to WindowManager through the application’s context instead of the activity’s context we can see now that the Overlay Window is not relevant to the activity any more but to the app.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">WINDOW</span> <span class="n">MANAGER</span> <span class="nf">TOKENS</span> <span class="p">(</span><span class="n">dumpsys</span> <span class="n">window</span> <span class="n">tokens</span><span class="o">)</span>
  <span class="n">All</span> <span class="nl">tokens:</span>
  <span class="n">WindowToken</span><span class="o">{</span><span class="mi">23292</span><span class="n">f77</span> <span class="kc">null</span><span class="o">}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">1</span><span class="n">cef1811</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=-</span><span class="mi">1</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>
 
 <span class="o">...</span>
 
  <span class="n">AppWindowToken</span><span class="o">{</span><span class="mi">21</span><span class="n">f5a48f</span> <span class="n">token</span><span class="o">=</span><span class="n">Token</span><span class="o">{</span><span class="mi">3</span><span class="n">dc7d7ee</span> <span class="n">ActivityRecord</span><span class="o">{</span><span class="mi">1</span><span class="n">e855169</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/.</span><span class="na">MainActivity</span> <span class="n">t618</span><span class="o">}}}:</span>
    <span class="n">windows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">39091423</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">windowType</span><span class="o">=</span><span class="mi">2</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">hasVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">app</span><span class="o">=</span><span class="kc">true</span> <span class="n">voiceInteraction</span><span class="o">=</span><span class="kc">false</span>
    <span class="n">allAppWindows</span><span class="o">=[</span><span class="n">Window</span><span class="o">{</span><span class="mi">39091423</span> <span class="n">u0</span> <span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">vourkosa</span><span class="o">.</span><span class="na">overlayapp</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">}]</span>
    <span class="n">groupId</span><span class="o">=</span><span class="mi">618</span> <span class="n">appFullscreen</span><span class="o">=</span><span class="kc">true</span> <span class="n">requestedOrientation</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">hiddenRequested</span><span class="o">=</span><span class="kc">false</span> <span class="n">clientHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">willBeHidden</span><span class="o">=</span><span class="kc">false</span> <span class="n">reportedDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">reportedVisible</span><span class="o">=</span><span class="kc">true</span>
    <span class="n">numInterestingWindows</span><span class="o">=</span><span class="mi">1</span> <span class="n">numDrawnWindows</span><span class="o">=</span><span class="mi">1</span> <span class="n">inPendingTransaction</span><span class="o">=</span><span class="kc">false</span> <span class="n">allDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="o">(</span><span class="n">animator</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
    <span class="n">startingData</span><span class="o">=</span><span class="kc">null</span> <span class="n">removed</span><span class="o">=</span><span class="kc">false</span> <span class="n">firstWindowDrawn</span><span class="o">=</span><span class="kc">true</span> <span class="n">mDeferRemoval</span><span class="o">=</span><span class="kc">false</span>
    
<span class="o">...</span>
</code></pre>
</div>

<p><img src="/images/android/overlay_app.png" /></p>

<p>This trick allows the Overlay view to live as far as the app lives. Once the application stops the Overlay view is removed too.</p>

<h4>2. Overlay through a service</h4>

<p>Another way to create an Overlay as a System Window that will be added above other applications is by adding that overlay through WindowManager in the same way as described in previous section but through a service that can run in the background.</p>

<p>A common usage of this approach can be found in Facebook chatheads and other popular apps. You just have to declare the service in the app’s AndroidManifest file.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">service</span> <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">".OverlayService"</span><span class="o">&gt;&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
</code></pre>
</div>

<p>and start or stop the service at any time:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="n">OverlayService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">activity</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="n">OverlayService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">activity</span><span class="o">.</span><span class="na">stopService</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</code></pre>
</div>

<p><img src="/images/android/androidhead.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OverlayService</span> <span class="kd">extends</span> <span class="n">Service</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">WindowManager</span> <span class="n">wm</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ImageView</span> <span class="n">androidHead</span><span class="o">;</span>
  
    <span class="nd">@Nullable</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">IBinder</span> <span class="n">onBind</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
        
        <span class="n">androidHead</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ImageView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">androidHead</span><span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_launcher</span><span class="o">);</span>

        <span class="n">wm</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">WINDOW_SERVICE</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">();</span>
        
        <span class="n">params</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">;</span>
        <span class="n">params</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">;</span>
        <span class="n">params</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_PRIORITY_PHONE</span><span class="o">;</span>
        <span class="n">params</span><span class="o">.</span><span class="na">flags</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_FOCUSABLE</span> <span class="o">|</span>
                <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_LAYOUT_NO_LIMITS</span> <span class="o">|</span>
                <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_TOUCH_MODAL</span><span class="o">;</span>
        <span class="n">params</span><span class="o">.</span><span class="na">format</span> <span class="o">=</span> <span class="n">PixelFormat</span><span class="o">.</span><span class="na">TRANSLUCENT</span><span class="o">;</span>
        <span class="n">params</span><span class="o">.</span><span class="na">gravity</span> <span class="o">=</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">TOP</span> <span class="o">|</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">LEFT</span><span class="o">;</span>

        <span class="n">wm</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">androidHead</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>

    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
        <span class="n">removeView</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="n">removeView</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">androidHead</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">wm</span><span class="o">.</span><span class="na">removeView</span><span class="o">(</span><span class="n">androidHead</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>As we have seen there are different ways to place overlays above an app or other apps by using WindowManager. However the need of requesting a special permission especially since Android Marshmallow or the need of declaring and using a service to keep the overlay independent of an app’s or activity’s lifecycle makes this approach less convenient.</p>

        
        </section>
       
 
 <div class="share-page">
    <a href="https://twitter.com/intent/tweet?text=Working with overlays - Life under WindowManager&url=http://vourkosa.github.io/android/2016/01/15/Working-with-overlays.html&via=vourkosa&related=vourkosa" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter"></i></a>
    &nbsp;&nbsp;<a href="https://facebook.com/sharer.php?u=http://vourkosa.github.io/android/2016/01/15/Working-with-overlays.html" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook"></i></a>
    &nbsp;&nbsp;<a href=" http://www.linkedin.com/shareArticle?mini=true&url=http://vourkosa.github.io/android/2016/01/15/Working-with-overlays.html&title=Working with overlays - Life under WindowManager&source=" rel="nofollow" target="_blank"><i class="fa fa-linkedin"></i></a>
    &nbsp;&nbsp;<a href="https://plus.google.com/share?url=http://vourkosa.github.io/android/2016/01/15/Working-with-overlays.html" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus"></i></a>
    &nbsp;&nbsp;<a href="http://www.reddit.com/submit?url=http://vourkosa.github.io/android/2016/01/15/Working-with-overlays.html" rel="nofollow" target="_blank" title="Share on Reddit"><i class="fa fa-reddit"></i></a>



</div>
</br>
</br>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vourkosa'; // required: replace example with your forum shortname
    	var disqus_developer = 1; // Comment out when the site is live
        var disqus_identifier = "/android/2016/01/15/Working-with-overlays.html";
//s.src = '//vourkosa.disqus.com/embed.js';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        <footer>
        <div class="foot">
            
            <a href="/monetization/2015/10/15/Monetizing-upon-unpredictability-and-variety-of-rewards.html" class="button special2">Previous</a> 
            
           <a href="/android/2016/02/06/Working-with-overlays-PhoneWindow-a-not-so-famous-window.html" class="button special2">Next</a>
        </footer>
  </div>
    </div>

</section>


            </div>
            <!-- Footer -->
    <section id="footer">
        <div class="container">
            <ul class="copyright">
                <li>&copy; Andreas Vourkos 2016. All rights reserved.</li>
                <li>A Jekyll Theme by: <a href="http://html5up.net">HTML5 UP</a></li>
            </ul>
        </div>
    </section>

		</div>
	</body>
</html>